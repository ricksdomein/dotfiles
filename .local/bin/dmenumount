#!/bin/bash

ignore=("/dev/sda1","/dev/sda2","/dev/sdb1","/dev/sdc1")


mountusb() {
    device="$(printf "$mount_devices" | awk '{$NF=""; print $0}' | dmenu -p "Mount:")"
    [[ -z $device ]] && exit
    device="$(printf "$mount_devices" | grep "$device")"
    udisksctl mount -b "$(echo "$device"| awk 'NF>1{print $NF}')"
	[[ "$?" == "0" ]] && notify-send -a "dmenumount" "USB mounting" "$device"
}

unmountusb() {
    device="$(printf "$unmount_devices" | awk '{$NF=""; print $0}' | dmenu -p "Unmount:")"
    [[ -z $device ]] && exit
    device="$(printf "$unmount_devices" | grep "$device")"
    udisksctl unmount -b "$(echo "$device"| awk 'NF>1{print $NF}')"
	[[ "$?" == "0" ]] && notify-send -a "dmenumount" "USB unmounting" "$device"
}

mount_devices=""
unmount_devices=""
while IFS='' read -r u || [ -n "$u" ]; do
     m="$(echo "$u" | awk '{print $1;}')"
     s="($(echo "$u" | awk '{print $3;}'))"
    if [ -n "$(udisksctl info -b $m | awk '{if(/IdType:\s*/) printf $2}')" ];then
        name="$(udisksctl info -b $m | grep '\s*Drive:' | sed 's:.*/::' | sed 's/_/ /g' | grep -wo '[^[:digit:]]\+')"
        if [ -n "$(echo "$u" | awk '$4!=""{printf "%s (%s)\n",$1,$3}')" ];then
            [[ " ${ignore[*]} " == *"$m"*  ]] || unmount_devices+="$(echo "$name $s $m")\n"
        else
            [[ " ${ignore[*]} " == *"$m"*  ]] || mount_devices+="$(echo "$name $s $m")\n"
        fi
    fi
done <<< $(lsblk -rpo "name,type,size,mountpoint" | grep 'part\|rom\|disk')


if [ -z "$unmount_devices" ]; then
    mountusb
elif [ -z "$mount_devices" ]; then
    unmountusb
else
    action="$(printf "Mount\nUnmount" | dmenu -p "Action:")"
    [ "$action" == "Mount" ] && mountusb || unmountusb
fi
